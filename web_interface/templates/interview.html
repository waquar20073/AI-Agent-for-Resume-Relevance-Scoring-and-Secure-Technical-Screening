{% extends "base.html" %}

{% block title %}Technical Interview - AI Recruitment Agent{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Interview Header -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        Technical Interview
                    </h4>
                    <div class="integrity-status">
                        <span class="badge bg-success">
                            <i class="fas fa-shield-alt me-1"></i>
                            Integrity Monitoring Active
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Candidate ID: {{ candidate_id }}</h6>
                        <p class="mb-0">This adaptive interview will assess your technical skills in Data Science and Agentic AI.</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="button" class="btn btn-success btn-lg" id="startInterviewBtn">
                            <i class="fas fa-play me-2"></i>
                            Start Interview
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Interview Interface -->
        <div id="interviewInterface" style="display: none;">
            <!-- Progress Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Interview Progress</span>
                        <span id="progressText">Question 1 of 15</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 6.67%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Question Display -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0" id="questionCategory">Loading...</h6>
                        <div class="question-meta">
                            <span class="badge bg-light text-dark me-2" id="questionDifficulty">Intermediate</span>
                            <span class="badge bg-warning" id="timeRemaining">
                                <i class="fas fa-clock me-1"></i>
                                <span id="timeValue">15:00</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="question-content">
                        <h5 id="questionText">Loading question...</h5>
                        <div id="codeTemplate" style="display: none;">
                            <h6 class="mt-3">Code Template:</h6>
                            <pre><code id="codeTemplateContent"></code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Answer Input -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Your Answer
                    </h6>
                </div>
                <div class="card-body">
                    <form id="answerForm">
                        <div class="mb-3">
                            <textarea class="form-control" id="answerText" rows="8" 
                                      placeholder="Type your answer here..." required></textarea>
                        </div>
                        
                        <div id="codeInput" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Code Solution:</label>
                                <textarea class="form-control font-monospace" id="codeSnippet" rows="10" 
                                          placeholder="Paste your code here..."></textarea>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" id="skipBtn">
                                <i class="fas fa-forward me-2"></i>
                                Skip Question
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-paper-plane me-2"></i>
                                Submit Answer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Feedback Display -->
            <div id="feedbackCard" class="card" style="display: none;">
                <div class="card-header {% if feedback and feedback.score >= 70 %}bg-success{% else %}bg-warning{% endif %} text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-comment-dots me-2"></i>
                        Answer Feedback
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>Score:</h6>
                            <h3 id="feedbackScore">-</h3>
                        </div>
                        <div class="col-md-9">
                            <h6>Feedback:</h6>
                            <p id="feedbackText">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Interview Complete -->
        <div id="interviewComplete" class="card" style="display: none;">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>
                    Interview Completed
                </h4>
            </div>
            <div class="card-body text-center">
                <h5>Thank you for completing the technical interview!</h5>
                <p class="mb-4">Your responses have been analyzed and a comprehensive report has been generated.</p>
                <a href="{{ url_for('interview_report') }}" class="btn btn-primary btn-lg me-3">
                    <i class="fas fa-file-alt me-2"></i>
                    View Report
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-home me-2"></i>
                    Return Home
                </a>
            </div>
        </div>
        
        <!-- Instructions Modal -->
        <div class="modal fade" id="instructionsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Interview Instructions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6>Before you begin:</h6>
                        <ul>
                            <li>Ensure you have a stable internet connection</li>
                            <li>Find a quiet environment without distractions</li>
                            <li>Have any necessary reference materials ready</li>
                            <li>The interview will adapt to your skill level</li>
                            <li>All answers are monitored for integrity</li>
                        </ul>
                        
                        <h6 class="mt-3">During the interview:</h6>
                        <ul>
                            <li>Read each question carefully</li>
                            <li>Provide detailed, thoughtful answers</li>
                            <li>For coding questions, use the provided template</li>
                            <li>Manage your time effectively</li>
                            <li>Be honest - don't use external resources</li>
                        </ul>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This interview uses AI-powered integrity monitoring to ensure fair assessment.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let interviewSession = null;
let currentQuestion = null;
let timer = null;
let timeRemaining = 0;

$(document).ready(function() {
    // Show instructions modal on page load
    const instructionsModal = new bootstrap.Modal(document.getElementById('instructionsModal'));
    instructionsModal.show();
    
    // Start interview button
    $('#startInterviewBtn').on('click', function() {
        startInterview();
    });
    
    // Answer form submission
    $('#answerForm').on('submit', function(e) {
        e.preventDefault();
        submitAnswer();
    });
    
    // Skip question
    $('#skipBtn').on('click', function() {
        if (confirm('Are you sure you want to skip this question?')) {
            submitAnswer(true); // Skip flag
        }
    });
});

function startInterview() {
    const candidateId = '{{ candidate_id }}';
    const categories = ['data_science_fundamentals', 'machine_learning', 'python_programming', 'agentic_ai_systems'];
    
    $.ajax({
        url: '/start_interview',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            candidate_id: candidateId,
            job_id: 'demo-job-' + Date.now(),
            categories: categories
        }),
        success: function(response) {
            if (response.success) {
                interviewSession = response.session_id;
                currentQuestion = response.first_question;
                
                // Show interview interface
                $('#interviewInterface').show();
                $('#startInterviewBtn').parent().parent().parent().hide();
                
                // Display first question
                displayQuestion(currentQuestion);
            } else {
                alert('Failed to start interview: ' + response.error);
            }
        },
        error: function() {
            alert('Failed to start interview. Please try again.');
        }
    });
}

function displayQuestion(question) {
    // Update question display
    $('#questionCategory').text(question.category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()));
    $('#questionDifficulty').text(question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1));
    $('#questionText').text(question.text);
    
    // Show code template if available
    if (question.code_template) {
        $('#codeTemplate').show();
        $('#codeTemplateContent').text(question.code_template);
        $('#codeInput').show();
    } else {
        $('#codeTemplate').hide();
        $('#codeInput').hide();
    }
    
    // Start timer
    startTimer(question.time_limit * 60); // Convert minutes to seconds
    
    // Clear previous answer and feedback
    $('#answerText').val('');
    $('#codeSnippet').val('');
    $('#feedbackCard').hide();
    
    // Enable submit button
    $('#submitBtn').prop('disabled', false);
}

function startTimer(seconds) {
    timeRemaining = seconds;
    updateTimerDisplay();
    
    if (timer) {
        clearInterval(timer);
    }
    
    timer = setInterval(function() {
        timeRemaining--;
        updateTimerDisplay();
        
        if (timeRemaining <= 0) {
            clearInterval(timer);
            submitAnswer(); // Auto-submit when time expires
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    $('#timeValue').text(minutes + ':' + seconds.toString().padStart(2, '0'));
    
    // Change color when time is running out
    if (timeRemaining <= 60) {
        $('#timeRemaining').removeClass('bg-warning').addClass('bg-danger');
    } else {
        $('#timeRemaining').removeClass('bg-danger').addClass('bg-warning');
    }
}

function submitAnswer(skip = false) {
    if (timer) {
        clearInterval(timer);
    }
    
    const answerText = $('#answerText').val();
    const codeSnippet = $('#codeSnippet').val();
    const timeTaken = (currentQuestion.time_limit * 60) - timeRemaining;
    
    if (!skip && !answerText.trim()) {
        alert('Please provide an answer before submitting.');
        return;
    }
    
    $('#submitBtn').prop('disabled', true);
    
    $.ajax({
        url: '/submit_answer',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            answer: skip ? 'SKIPPED' : answerText,
            code_snippet: codeSnippet,
            time_taken: timeTaken
        }),
        success: function(response) {
            // Show feedback
            showFeedback(response.answer_score, response.answer_feedback);
            
            // Update progress
            updateProgress(response.session_progress);
            
            if (response.session_complete) {
                // Interview complete
                setTimeout(function() {
                    $('#interviewInterface').hide();
                    $('#interviewComplete').show();
                }, 3000);
            } else if (response.next_question) {
                // Load next question after delay
                setTimeout(function() {
                    currentQuestion = response.next_question;
                    displayQuestion(currentQuestion);
                }, 3000);
            }
        },
        error: function() {
            alert('Failed to submit answer. Please try again.');
            $('#submitBtn').prop('disabled', false);
        }
    });
}

function showFeedback(score, feedback) {
    $('#feedbackScore').text(score.toFixed(1) + '%');
    $('#feedbackText').text(feedback);
    
    // Update card header color based on score
    const header = $('#feedbackCard .card-header');
    header.removeClass('bg-success bg-warning');
    header.addClass(score >= 70 ? 'bg-success' : 'bg-warning');
    
    $('#feedbackCard').show();
}

function updateProgress(progress) {
    const percentage = (progress.questions_asked / progress.max_questions) * 100;
    $('#progressBar').css('width', percentage + '%');
    $('#progressText').text(`Question ${progress.questions_asked} of ${progress.max_questions}`);
}
</script>
{% endblock %}
